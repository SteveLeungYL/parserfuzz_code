WITH descs AS ( SELECT d FROM ( SELECT crdb_internal.pb_to_json( 'cockroach.sql.sqlbase.Descriptor', descriptor, false )->'table' AS d FROM system.descriptor ) WHERE d IS NOT NULL ), bad_descs AS ( SELECT d, idx FROM ( SELECT d, d->'primaryIndex' AS pi, json_array_elements(d->'indexes') AS idx FROM descs ) WHERE (pi->>'id')::INT8 > (idx->>'id')::INT8 ) SELECT database_name, schema_name, name AS table_name, table_id, idx->>'name' AS index_name, (idx->>'id')::INT8 AS index_id FROM crdb_internal.tables JOIN bad_descs ON (table_id = (d->>'id')::INT8);
