call mtr.add_suppression(".*The system table mysql.global_grants.*");
call mtr.add_suppression("ACL table mysql.global_grants missing. Some operations may fail.");
call mtr.add_suppression("An empty or illegal privilege identifier was ignored when global privileges were read from disk.");
CREATE TABLE mysql.backup_global_grants AS SELECT * FROM mysql.global_grants;
CREATE USER 'u1'@'localhost' IDENTIFIED BY '123';
GRANT SYSTEM_VARIABLES_ADMIN ON *.* TO u1@localhost;
SHOW GRANTS FOR u1@localhost;
SELECT * FROM mysql.global_grants ORDER BY USER, PRIV, WITH_GRANT_OPTION;
GRANT SYSTEM_VARIABLES_ADMIN ON *.* TO u1@localhost WITH GRANT OPTION;
SHOW GRANTS FOR u1@localhost;
SELECT * FROM mysql.global_grants ORDER BY USER, PRIV, WITH_GRANT_OPTION;
FLUSH PRIVILEGES;
SHOW GRANTS FOR u1@localhost;
SELECT * FROM mysql.global_grants ORDER BY USER, PRIV, WITH_GRANT_OPTION;
GRANT SYSTEM_VARIABLES_ADMIN ON *.* TO u1@localhost WITH GRANT OPTION;
GRANT SYSTEM_VARIABLES_ADMIN ON *.* TO u1@localhost;
SHOW GRANTS FOR u1@localhost;
GRANT SYSTEM_VARIABLES_ADMIN ON *.* TO u1@localhost WITH GRANT OPTION;
GRANT SYSTEM_VARIABLES_ADMIN ON *.* TO u1@localhost WITH GRANT OPTION;
SHOW GRANTS FOR u1@localhost;
SELECT * FROM mysql.global_grants ORDER BY USER, PRIV, WITH_GRANT_OPTION;
SELECT * FROM information_schema.user_privileges WHERE GRANTEE LIKE '%u1%' ORDER BY GRANTEE, PRIVILEGE_TYPE, IS_GRANTABLE;
FLUSH PRIVILEGES;
SHOW GRANTS FOR u1@localhost;
SELECT * FROM mysql.global_grants ORDER BY USER, PRIV, WITH_GRANT_OPTION;
GRANT SYSTEM_VARIABLES_ADMIN ON *.* TO u1@localhost;
SHOW GRANTS FOR u1@localhost;
SELECT * FROM mysql.global_grants ORDER BY USER, PRIV, WITH_GRANT_OPTION;
REVOKE SYSTEM_VARIABLES_ADMIN ON *.* FROM u1@localhost;
REVOKE SYSTEM_VARIABLES_ADMIN ON *.* FROM u1@localhost;
SHOW GRANTS FOR u1@localhost;
REVOKE ALL ON *.* FROM u1@localhost;
SHOW GRANTS FOR u1@localhost;
SELECT * FROM information_schema.user_privileges WHERE GRANTEE LIKE '%u1%' ORDER BY GRANTEE, PRIVILEGE_TYPE, IS_GRANTABLE;
INSERT INTO mysql.global_grants VALUES ('u1','localhost','RUBBISH','N');
FLUSH PRIVILEGES;
SHOW GRANTS FOR u1@localhost;
INSERT INTO mysql.global_grants VALUES ('u1','localhost','RUBBISH','Y');
INSERT INTO mysql.global_grants VALUES ('u1','localhoster','RUBBISH','N');
FLUSH PRIVILEGES;
SHOW GRANTS FOR u1@localhost;
DROP USER u1@localhost;
SELECT * FROM mysql.global_grants ORDER BY USER, PRIV, WITH_GRANT_OPTION;
SELECT * FROM information_schema.user_privileges WHERE GRANTEE LIKE '%u1%' ORDER BY GRANTEE, PRIVILEGE_TYPE, IS_GRANTABLE;
CREATE USER u1@localhost IDENTIFIED BY 'foo';
GRANT SYSTEM_VARIABLES_ADMIN, ROLE_ADMIN, BINLOG_ADMIN ON *.* TO u1@localhost;
GRANT GROUP_REPLICATION_ADMIN ON *.* TO u1@localhost WITH GRANT OPTION;
RENAME USER u1@localhost TO u2@localhost;
SHOW GRANTS FOR u2@localhost;
SHOW GRANTS FOR u1@localhost;
SELECT * FROM mysql.global_grants ORDER BY USER, PRIV, WITH_GRANT_OPTION;
SELECT * FROM information_schema.user_privileges WHERE GRANTEE LIKE '%u1%' ORDER BY GRANTEE, PRIVILEGE_TYPE, IS_GRANTABLE;
SELECT * FROM information_schema.user_privileges WHERE GRANTEE LIKE '%u2%' ORDER BY GRANTEE, PRIVILEGE_TYPE, IS_GRANTABLE;
DROP USER u2@localhost;
CREATE USER u1@localhost IDENTIFIED BY 'foo';
GRANT SYSTEM_VARIABLES_ADMIN, SELECT ON *.* TO u1@localhost WITH GRANT OPTION;
SHOW GRANTS FOR u1@localhost;
SELECT * FROM mysql.global_grants ORDER BY USER, PRIV, WITH_GRANT_OPTION;
SELECT * FROM information_schema.user_privileges WHERE GRANTEE LIKE '%u1%' ORDER BY GRANTEE, PRIVILEGE_TYPE, IS_GRANTABLE;
CREATE TABLE t1 (c1 int);
GRANT SYSTEM_VARIABLES_ADMIN ON t1.* TO u1@localhost;
DROP USER u1@localhost;
DROP TABLE t1;
INSERT INTO mysql.global_grants VALUES('u1', '%', 'ROUTINE_GRANT', 'Y');
FLUSH PRIVILEGES;
SHOW GRANTS FOR `u1`@`%`;
INSERT INTO mysql.global_grants VALUES('u1_non', '%', 'HELLOWORLD', 'Y');
FLUSH PRIVILEGES;
SHOW GRANTS FOR `u1`@`%`;
CREATE USER u1@localhost;
INSERT INTO mysql.global_grants VALUES('u1', 'localhost', 'HelloWorld', 'Y');
FLUSH PRIVILEGES;
SHOW GRANTS FOR `u1`@`localhost`;
DROP USER u1@localhost;
SHOW GRANTS FOR `u1`@`localhost`;
DELETE FROM mysql.global_grants;
FLUSH PRIVILEGES;
SET GLOBAL event_scheduler = 1;
CREATE DATABASE restricted;
CREATE TABLE restricted.t1 (c1 int, restricted int);
INSERT INTO restricted.t1 VALUES (1,2);
CREATE USER u1@localhost IDENTIFIED BY 'foo';
GRANT SET_USER_ID, CREATE VIEW, CREATE ROUTINE, EXECUTE, EVENT ON *.* TO u1@localhost;
SELECT * from restricted.t1;
USE test;
CREATE DEFINER=root@localhost PROCEDURE p1() SELECT * FROM restricted.t1;
CALL p1();
CREATE TABLE test.t1 (c1 INT);
CREATE DEFINER=root@localhost TRIGGER test.tr1 BEFORE INSERT ON test.t1 FOR EACH ROW INSERT INTO restricted.t1 VALUES (1,1);
INSERT INTO test.t1 VALUES (1);
SELECT * FROM restricted.t1;
DROP TRIGGER test.tr1;
CREATE DEFINER=root@localhost SQL SECURITY DEFINER VIEW v1 AS SELECT a.restricted FROM restricted.t1 as a;
GRANT INSERT(restricted) ON restricted.t1 TO u1@localhost;
SHOW GRANTS FOR CURRENT_USER();
CREATE DEFINER=root@localhost SQL SECURITY DEFINER VIEW v1 AS SELECT a.restricted FROM restricted.t1 as a;
SELECT * FROM v1;
CREATE DEFINER=root@localhost EVENT test.eve1 ON SCHEDULE AT CURRENT_TIMESTAMP + INTERVAL 2 SECOND DO BEGIN INSERT INTO restricted.t1 VALUES (5,5); END;;
SELECT * FROM v1;
DROP PROCEDURE p1;
DROP DATABASE restricted;
DROP USER u1@localhost;
DROP VIEW test.v1;
DROP TABLE test.t1;
SET GLOBAL event_scheduler = 0;
CREATE USER u1@localhost IDENTIFIED BY 'foo';
GRANT ROLE_ADMIN ON mysql.user TO u1@localhost;
GRANT ROLE_ADMIN ON * TO u1@localhost;
DROP USER u1@localhost;
CREATE USER u1@localhost IDENTIFIED BY 'foo';
CREATE USER u2@localhost IDENTIFIED BY 'foo';
INSERT INTO mysql.global_grants VALUES('u1', 'localhost', 'ROLE_ADMIN', 'Y');
INSERT INTO mysql.global_grants VALUES('u1', 'localhost', 'SYSTEM_VARIABLES_ADMIN', 'N');
FLUSH PRIVILEGES;
GRANT SYSTEM_VARIABLES_ADMIN ON *.* TO u2@localhost;
SHOW GRANTS FOR CURRENT_USER();
GRANT ROLE_ADMIN ON *.* TO u2@localhost;
REVOKE ROLE_ADMIN ON *.* FROM u2@localhost;
GRANT SYSTEM_VARIABLES_ADMIN ON *.* TO u2@localhost;
DROP USER u1@localhost;
DROP USER u2@localhost;
DROP USER IF EXISTS u1, r1;
CREATE USER u1@localhost IDENTIFIED BY 'foo';
CREATE ROLE r1;
GRANT ROLE_ADMIN ON *.* to r1 WITH GRANT OPTION;
GRANT r1 to u1@localhost;
SET ROLE r1;
GRANT ROLE_ADMIN ON *.* to u1@localhost;
GRANT ROLE_ADMIN ON *.* to u1@localhost;
SHOW GRANTS FOR CURRENT_USER();
DROP USER u1@localhost;
DROP ROLE r1;
DROP USER IF EXISTS u1;
CREATE USER u1, u1@localhost;
GRANT ROLE_ADMIN ON *.* TO u1;
INSERT INTO mysql.global_grants VALUES('u1', '%', 'non_documented_privilege', 'Y');
INSERT INTO mysql.global_grants VALUES('u1', 'localhost', 'non_documented_privilege', 'Y');
FLUSH PRIVILEGES;
SHOW GRANTS FOR u1;
SHOW GRANTS FOR u1@localhost;
REVOKE ALL ON *.* FROM u1;
REVOKE ALL ON *.* FROM u1@localhost;
SELECT * FROM mysql.global_grants;
SHOW GRANTS FOR u1;
FLUSH PRIVILEGES;
SHOW GRANTS FOR u1;
SELECT * FROM mysql.global_grants;
DROP USER IF EXISTS 'u1'@'localhost';
DROP TABLE IF EXISTS test.t1;
CREATE TABLE test.t1(a int);
CREATE USER 'u1'@'localhost' IDENTIFIED BY 'pwd';
GRANT ALL ON test.t1 TO 'u1'@'localhost';
GRANT CONNECTION_ADMIN, SYSTEM_VARIABLES_ADMIN, SELECT ON *.* TO u1@localhost;
SET GLOBAL init_connect = 'INSERT INTO test.t1 values(555)';
SELECT * FROM test.t1;
SET GLOBAL init_connect = '';
SET GLOBAL offline_mode = 'ON';
SET GLOBAL offline_mode = 'OFF';
SET GLOBAL read_only = 'ON';
INSERT INTO test.t1 VALUES(1);
SET GLOBAL read_only = 'OFF';
SET @old_log_output=          @@global.log_output;
SET @old_general_log=         @@global.general_log;
SET @old_general_log_file=    @@global.general_log_file;
TRUNCATE TABLE mysql.general_log;
SET GLOBAL log_output =       'TABLE';
SET GLOBAL general_log=       'ON';
TRUNCATE TABLE mysql.general_log;
SET sql_log_off = ON;
SELECT 'helloworld';
SELECT COUNT(*) FROM mysql.general_log WHERE ARGUMENT like '%helloworld%';
SET sql_log_off = OFF;
SELECT 'helloworld';
SELECT COUNT(*)>=2 FROM mysql.general_log WHERE ARGUMENT like '%helloworld%';
TRUNCATE TABLE mysql.general_log;
REVOKE CONNECTION_ADMIN ON *.* from u1@localhost;
SHOW GRANTS FOR u1@localhost;
SET GLOBAL init_connect = 'INSERT INTO test.t1 values(555)';
SELECT * FROM test.t1;
SET GLOBAL init_connect = '';
SET GLOBAL offline_mode = 'ON';
SET GLOBAL offline_mode = 'OFF';
SET GLOBAL read_only = 'ON';
INSERT INTO test.t1 VALUES(1);
REVOKE CONNECTION_ADMIN ON *.* from u1@localhost;
SET GLOBAL read_only = 'OFF';
SHOW GRANTS FOR u1@localhost;
TRUNCATE TABLE mysql.general_log;
SET sql_log_off = OFF;
SELECT 'helloworld';
SELECT COUNT(*)>0 FROM mysql.general_log WHERE ARGUMENT like '%helloworld%';
TRUNCATE TABLE mysql.general_log;
SET sql_log_off = ON;
SELECT 'helloworld';
SELECT COUNT(*)>0 FROM mysql.general_log WHERE ARGUMENT like '%helloworld%';
TRUNCATE TABLE mysql.general_log;
SET sql_log_off = OFF;
SET GLOBAL general_log_file=  @old_general_log_file;
SET GLOBAL general_log=       @old_general_log;
SET GLOBAL log_output=        @old_log_output;
TRUNCATE TABLE mysql.general_log;
DROP USER IF EXISTS u1, r1, r2;
CREATE USER u1, r1, r2;
GRANT ROLE_ADMIN, BINLOG_ADMIN, SET_USER_ID, CREATE on *.* to r1;
GRANT ROLE_ADMIN, GROUP_REPLICATION_ADMIN, ENCRYPTION_KEY_ADMIN, ALTER, RELOAD on *.* to r2;
GRANT SYSTEM_VARIABLES_ADMIN, REPLICATION_SLAVE_ADMIN, SELECT ON *.* to u1;
GRANT r1, r2 TO u1;
SHOW GRANTS FOR u1 using r1;
SHOW GRANTS FOR u1 using r2;
DROP ROLE r1;
SHOW GRANTS FOR u1 using r1;
SHOW GRANTS FOR u1;
GRANT ALL ON *.* to u1;
SHOW GRANTS FOR u1;
INSERT INTO mysql.global_grants VALUES('u1', '%', 'length_32_abcdefghijklmnopqrstux', 'Y');
FLUSH PRIVILEGES;
INSERT INTO mysql.global_grants VALUES('u1', '%', 'length_33_abcdefghijklmnopqrstuvw', 'Y');
SHOW PRIVILEGES;
TRUNCATE TABLE mysql.global_grants;
FLUSH PRIVILEGES;
GRANT ALL ON *.* to root@localhost WITH GRANT OPTION;
DROP USER u1@localhost;
CREATE USER u1@localhost IDENTIFIED BY 'pwd';
START SLAVE;
STOP SLAVE;
GRANT REPLICATION_SLAVE_ADMIN ON *.* to u1@localhost;
START SLAVE;
START SLAVE;
REVOKE 'C' @c06 ON c02.`z1` FROM 'C' @c03;
GRANT '' @c05 ON TABLE *.* TO ''@'' IDENTIFIED WITH c06 BY '' REQUIRE X509;
GRANT '' @c05 ON TABLE * TO CURRENT_USER()IDENTIFIED WITH c07 REQUIRE X509 WITH  MAX_QUERIES_PER_HOUR 0x2e3;
GRANT WRAPPER @c04 ON FUNCTION c02.* TO CURRENT_USER IDENTIFIED WITH '' BY '?'  REQUIRE SSL;
GRANT '' @c03 ON c05.* TO '' @ '';
DROP USER u1@localhost, u1, r2;
DROP TABLE test.t1;
CREATE USER u1@localhost IDENTIFIED BY 'pwd';
CREATE DATABASE db1_protected;
CREATE DATABASE db1;
GRANT ALL ON db1.* TO u1@localhost;
DROP TABLE mysql.global_grants;
show session status;
show session status;
show session status;
show session status;
show session status;
show session status;
show session status;
show session status;
show session status;
show session status;
show session status;
show session status;
show session status;
show session status;
show session status;
DROP DATABASE db1_protected;
DROP DATABASE db1;
DROP DATABASE db1_protected;
CREATE TABLE IF NOT EXISTS mysql.global_grants ( USER CHAR(32) BINARY DEFAULT '' NOT NULL, HOST CHAR(255) CHARACTER SET ASCII DEFAULT '' NOT NULL, PRIV CHAR(32) COLLATE UTF8_GENERAL_CI DEFAULT '' NOT NULL, WITH_GRANT_OPTION ENUM('N','Y') COLLATE UTF8_GENERAL_CI DEFAULT 'N' NOT NULL, PRIMARY KEY (USER,HOST,PRIV) ) engine=InnoDB STATS_PERSISTENT=0 CHARACTER SET utf8 COLLATE utf8_bin comment='Extended global grants' ROW_FORMAT=DYNAMIC TABLESPACE=mysql;
GRANT SYSTEM_VARIABLES_ADMIN ON *.* TO 'mysql.session'@localhost;
GRANT SESSION_VARIABLES_ADMIN ON *.* TO 'mysql.session'@localhost;
GRANT PERSIST_RO_VARIABLES_ADMIN ON *.* TO 'mysql.session'@localhost;
GRANT CLONE_ADMIN ON *.* TO 'mysql.session'@localhost;
GRANT BACKUP_ADMIN ON *.* TO 'mysql.session'@localhost;
GRANT CONNECTION_ADMIN ON *.* TO 'mysql.session'@localhost;
GRANT SYSTEM_USER ON *.* TO 'mysql.session'@localhost;
show session status;
show session status;
show session status;
show session status;
show session status;
show session status;
show session status;
show session status;
show session status;
show session status;
show session status;
show session status;
show session status;
show session status;
show session status;
show session status;
DROP USER u1@localhost;
GRANT ALL ON *.* TO root@localhost WITH GRANT OPTION;
CREATE USER u1;
CREATE USER u2;
CREATE USER u3;
GRANT SYSTEM_VARIABLES_ADMIN, SELECT ON *.* TO u1;
GRANT SYSTEM_VARIABLES_ADMIN, SELECT ON *.* TO u2;
GRANT XA_RECOVER_ADMIN ON *.* TO u1 WITH GRANT OPTION;
GRANT XA_RECOVER_ADMIN ON *.* TO u2;
SHOW GRANTS FOR u1;
SHOW GRANTS FOR u2;
show session status;
GRANT XA_RECOVER_ADMIN ON *.* TO u3;
DROP USER u1;
DROP USER u2;
DROP USER u3;
CREATE USER u1@localhost IDENTIFIED BY 'foo';
GRANT ALL ON *.* TO u1@localhost;
SHOW GRANTS;
REVOKE ALL ON *.* FROM CURRENT_USER();
SHOW GRANTS;
DROP USER u1@localhost;
CREATE USER u1;
GRANT BINLOG_ADMIN ON *.* TO u1;
GRANT INSERT ON *.* TO u1;
SHOW GRANTS FOR u1;
SELECT * FROM mysql.global_grants WHERE USER='u1';
GRANT GRANT OPTION ON *.* TO u1;
SHOW GRANTS FOR u1;
SELECT * FROM mysql.global_grants WHERE USER='u1';
GRANT SYSTEM_VARIABLES_ADMIN, RESOURCE_GROUP_ADMIN ON *.* TO u1;
SHOW GRANTS FOR u1;
SELECT * FROM mysql.global_grants WHERE USER='u1';
GRANT GRANT OPTION ON *.* TO u1;
SHOW GRANTS FOR u1;
SELECT * FROM mysql.global_grants WHERE USER='u1';
GRANT XA_RECOVER_ADMIN ON *.* TO u1;
GRANT CONNECTION_ADMIN ON *.* TO u1 WITH GRANT OPTION;
SHOW GRANTS FOR u1;
SELECT * FROM mysql.global_grants WHERE USER='u1';
GRANT SELECT ON *.* TO u1 WITH GRANT OPTION;
SHOW GRANTS FOR u1;
SELECT * FROM mysql.global_grants WHERE USER='u1';
GRANT DELETE, GRANT OPTION ON *.* TO u1;
SHOW GRANTS FOR u1;
SELECT * FROM mysql.global_grants WHERE USER='u1';
GRANT PERSIST_RO_VARIABLES_ADMIN ON *.* TO u1;
SHOW GRANTS FOR u1;
SELECT * FROM mysql.global_grants WHERE USER='u1';
GRANT REPLICATION_SLAVE_ADMIN ON *.* TO u1 WITH GRANT OPTION;
SHOW GRANTS FOR u1;
SELECT * FROM mysql.global_grants WHERE USER='u1';
GRANT GRANT OPTION ON *.* TO u1 WITH GRANT OPTION;
SHOW GRANTS FOR u1;
SELECT * FROM mysql.global_grants WHERE USER='u1';
REVOKE RESOURCE_GROUP_ADMIN ON *.* FROM u1;
FLUSH PRIVILEGES;
SHOW GRANTS FOR u1;
SELECT * FROM mysql.global_grants WHERE USER='u1';
REVOKE PERSIST_RO_VARIABLES_ADMIN, GRANT OPTION ON *.* FROM u1;
FLUSH PRIVILEGES;
SHOW GRANTS FOR u1;
SELECT * FROM mysql.global_grants WHERE USER='u1';
RESET MASTER;
GRANT SELECT ON *.* TO u1;
GRANT PERSIST_RO_VARIABLES_ADMIN, DELETE ON *.* TO u1 WITH GRANT OPTION;
GRANT GRANT OPTION ON *.* TO u1;
DROP USER u1;
RESET MASTER;
RESET SLAVE ALL;
INSERT INTO mysql.global_grants (user, host, priv) values ('', '%', ' ');
FLUSH PRIVILEGES;
DELETE FROM mysql.global_grants WHERE user = '' AND host = '%' AND priv = ' ';
INSERT INTO mysql.global_grants (user, host, priv) values ('', '', '');
FLUSH PRIVILEGES;
DELETE FROM mysql.global_grants WHERE user = '' AND host = '' AND priv = '';
INSERT INTO mysql.global_grants (user, host, priv) values (' ', '', '');
FLUSH PRIVILEGES;
DELETE FROM mysql.global_grants WHERE user = '' AND host = ' ' AND priv = '';
INSERT INTO mysql.global_grants (user, host, priv) values (' ', ' ', '');
FLUSH PRIVILEGES;
DELETE FROM mysql.global_grants WHERE user = ' ' AND host = ' ' AND priv = '';
INSERT INTO mysql.global_grants (user, host, priv) values ('', '', ' ');
FLUSH PRIVILEGES;
DELETE FROM mysql.global_grants WHERE user = '' AND host = '' AND priv = ' ';
FLUSH PRIVILEGES;
DELETE FROM mysql.global_grants;
INSERT INTO mysql.global_grants SELECT * FROM mysql.backup_global_grants;
FLUSH PRIVILEGES;
DROP TABLE mysql.backup_global_grants;
