call mtr.add_suppression("Got an error from thread_id=.*ha_myisam.cc:");
call mtr.add_suppression("MySQL thread id .*, query id .* localhost.*root Checking table");
call mtr.add_suppression(" '\..test.t1'");
set @start_table_open_cache=@@global.table_open_cache;
set @start_table_definition_cache=@@global.table_definition_cache;
set global table_open_cache=256;
set global table_definition_cache=400;
drop procedure if exists p_create;
create procedure p_create() begin declare i int default 1; set @lock_table_stmt="lock table "; set @drop_table_stmt="drop table "; while i < @@global.table_definition_cache + 1 do set @table_name=concat("t_", i); set @opt_comma=if(i=1, "", ", "); set @lock_table_stmt=concat(@lock_table_stmt, @opt_comma, @table_name, " read"); set @drop_table_stmt=concat(@drop_table_stmt, @opt_comma, @table_name); set @create_table_stmt=concat("create table if not exists ", @table_name, " (a int)"); prepare stmt from @create_table_stmt; execute stmt; deallocate prepare stmt; set i= i+1; end while; end;
call p_create();
drop procedure p_create;
lock table t_1 read, t_2 read, t_3 read, t_4 read, t_5 read, t_6 read, t_7 read, t_8 read, t_9 read, t_10 read, t_11 read, t_12 read, t_13 read, t_14 read, t_15 read, t_16 read, t_17 read, t_18 read, t_19 read, t_20 read, t_21 read, t_22 read, t_23 read, t_24 read, t_25 read, t_26 read, t_27 read, t_28 read, t_29 read, t_30 read, t_31 read, t_32 read, t_33 read, t_34 read, t_35 read, t_36 read, t_37 read, t_38 read, t_39 read, t_40 read, t_41 read, t_42 read, t_43 read, t_44 read, t_45 read, t_46 read, t_47 read, t_48 read, t_49 read, t_50 read, t_51 read, t_52 read, t_53 read, t_54 read, t_55 read, t_56 read, t_57 read, t_58 read, t_59 read, t_60 read, t_61 read, t_62 read, t_63 read, t_64 read, t_65 read, t_66 read, t_67 read, t_68 read, t_69 read, t_70 read, t_71 read, t_72 read, t_73 read, t_74 read, t_75 read, t_76 read, t_77 read, t_78 read, t_79 read, t_80 read, t_81 read, t_82 read, t_83 read, t_84 read, t_85 read, t_86 read, t_87 read, t_88 read, t_89 read, t_90 read, t_91 read, t_92 read, t_93 read, t_94 read, t_95 read, t_96 read, t_97 read, t_98 read, t_99 read, t_100 read, t_101 read, t_102 read, t_103 read, t_104 read, t_105 read, t_106 read, t_107 read, t_108 read, t_109 read, t_110 read, t_111 read, t_112 read, t_113 read, t_114 read, t_115 read, t_116 read, t_117 read, t_118 read, t_119 read, t_120 read, t_121 read, t_122 read, t_123 read, t_124 read, t_125 read, t_126 read, t_127 read, t_128 read, t_129 read, t_130 read, t_131 read, t_132 read, t_133 read, t_134 read, t_135 read, t_136 read, t_137 read, t_138 read, t_139 read, t_140 read, t_141 read, t_142 read, t_143 read, t_144 read, t_145 read, t_146 read, t_147 read, t_148 read, t_149 read, t_150 read, t_151 read, t_152 read, t_153 read, t_154 read, t_155 read, t_156 read, t_157 read, t_158 read, t_159 read, t_160 read, t_161 read, t_162 read, t_163 read, t_164 read, t_165 read, t_166 read, t_167 read, t_168 read, t_169 read, t_170 read, t_171 read, t_172 read, t_173 read, t_174 read, t_175 read, t_176 read, t_177 read, t_178 read, t_179 read, t_180 read, t_181 read, t_182 read, t_183 read, t_184 read, t_185 read, t_186 read, t_187 read, t_188 read, t_189 read, t_190 read, t_191 read, t_192 read, t_193 read, t_194 read, t_195 read, t_196 read, t_197 read, t_198 read, t_199 read, t_200 read, t_201 read, t_202 read, t_203 read, t_204 read, t_205 read, t_206 read, t_207 read, t_208 read, t_209 read, t_210 read, t_211 read, t_212 read, t_213 read, t_214 read, t_215 read, t_216 read, t_217 read, t_218 read, t_219 read, t_220 read, t_221 read, t_222 read, t_223 read, t_224 read, t_225 read, t_226 read, t_227 read, t_228 read, t_229 read, t_230 read, t_231 read, t_232 read, t_233 read, t_234 read, t_235 read, t_236 read, t_237 read, t_238 read, t_239 read, t_240 read, t_241 read, t_242 read, t_243 read, t_244 read, t_245 read, t_246 read, t_247 read, t_248 read, t_249 read, t_250 read, t_251 read, t_252 read, t_253 read, t_254 read, t_255 read, t_256 read, t_257 read, t_258 read, t_259 read, t_260 read, t_261 read, t_262 read, t_263 read, t_264 read, t_265 read, t_266 read, t_267 read, t_268 read, t_269 read, t_270 read, t_271 read, t_272 read, t_273 read, t_274 read, t_275 read, t_276 read, t_277 read, t_278 read, t_279 read, t_280 read, t_281 read, t_282 read, t_283 read, t_284 read, t_285 read, t_286 read, t_287 read, t_288 read, t_289 read, t_290 read, t_291 read, t_292 read, t_293 read, t_294 read, t_295 read, t_296 read, t_297 read, t_298 read, t_299 read, t_300 read, t_301 read, t_302 read, t_303 read, t_304 read, t_305 read, t_306 read, t_307 read, t_308 read, t_309 read, t_310 read, t_311 read, t_312 read, t_313 read, t_314 read, t_315 read, t_316 read, t_317 read, t_318 read, t_319 read, t_320 read, t_321 read, t_322 read, t_323 read, t_324 read, t_325 read, t_326 read, t_327 read, t_328 read, t_329 read, t_330 read, t_331 read, t_332 read, t_333 read, t_334 read, t_335 read, t_336 read, t_337 read, t_338 read, t_339 read, t_340 read, t_341 read, t_342 read, t_343 read, t_344 read, t_345 read, t_346 read, t_347 read, t_348 read, t_349 read, t_350 read, t_351 read, t_352 read, t_353 read, t_354 read, t_355 read, t_356 read, t_357 read, t_358 read, t_359 read, t_360 read, t_361 read, t_362 read, t_363 read, t_364 read, t_365 read, t_366 read, t_367 read, t_368 read, t_369 read, t_370 read, t_371 read, t_372 read, t_373 read, t_374 read, t_375 read, t_376 read, t_377 read, t_378 read, t_379 read, t_380 read, t_381 read, t_382 read, t_383 read, t_384 read, t_385 read, t_386 read, t_387 read, t_388 read, t_389 read, t_390 read, t_391 read, t_392 read, t_393 read, t_394 read, t_395 read, t_396 read, t_397 read, t_398 read, t_399 read, t_400 read;
drop table if exists t1, t1_mrg, t1_copy;
create table t1 (a int, key(a)) engine=myisam;
create table t1_mrg (a int) union (t1) engine=merge;
insert into  t1 (a) values (1), (2), (3);
flush table t1;
insert into  t1 (a) values (4), (5), (6);
flush table t1;
check table t1;
select * from t1_mrg;
drop table t1, t1_mrg;
unlock tables;
prepare stmt from @drop_table_stmt;
execute stmt;
deallocate prepare stmt;
set @@global.table_definition_cache=@start_table_definition_cache;
set @@global.table_open_cache=@start_table_open_cache;
create table t1 (a int, key(a)) engine=myisam;
create table t2 (a int);
insert into t2 values (1);
insert into  t1 (a) values (1);
flush table t1;
insert into  t1 (a) values (4);
flush table t1;
check table t1;
set autocommit = 0;
select * from t2;
select * from t1;
ALTER TABLE t2 ADD val INT;
ROLLBACK;
SET autocommit = 1;
REAP;
drop table t1, t2;
